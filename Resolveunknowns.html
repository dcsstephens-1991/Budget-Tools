<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <style>
    body { font-family: 'Segoe UI', Roboto, sans-serif; padding: 20px; background: #f4f4f9; color: #333; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; margin:0; }
    
    /* Header & Toolbar */
    .header { margin-bottom: 20px; flex-shrink: 0; }
    h3 { margin: 0 0 15px 0; color: #7b2cbf; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
    
    .toolbar { display: flex; gap: 15px; align-items: center; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-wrap: wrap; }
    .search-box { flex-grow: 1; position: relative; }
    .search-box input { width: 100%; padding: 10px 35px 10px 15px; border: 1px solid #ddd; border-radius: 20px; outline: none; transition: border 0.2s; }
    .search-box input:focus { border-color: #7b2cbf; }
    .search-icon { position: absolute; right: 12px; top: 10px; color: #999; }
    
    .btn-ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.15); transition: transform 0.1s; }
    .btn-ai:hover { transform: translateY(-1px); }
    
    /* Table Area */
    .table-container { flex-grow: 1; overflow-y: auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 800px; }
    
    th { position: sticky; top: 0; background: #f8f9fa; color: #555; font-weight: 600; padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; z-index: 10; font-size: 13px; }
    td { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; font-size: 13px; }
    tr:hover td { background-color: #fafafa; }
    tr.ai-guessed td { background-color: #f0f7ff; }

    /* Columns */
    .col-desc { font-weight: 600; color: #2c3e50; width: 30%; }
    .col-meta { font-family: monospace; color: #666; font-size: 12px; width: 10%; }
    .col-cat { width: 30%; }
    .col-type { width: 15%; }
    .col-action { width: 10%; text-align: center; }

    /* Inputs */
    select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: white; }
    .search-link { color: #999; text-decoration: none; font-size: 12px; margin-left: 8px; }
    .search-link:hover { color: #7b2cbf; }

    /* Footer */
    .footer { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .btn-save { background: #7b2cbf; color: white; border: none; padding: 10px 25px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 14px; }
    .btn-save:hover { background: #6a26a3; }
    .status { color: #666; font-size: 13px; font-style: italic; }

    /* Loading Overlay */
    #loader { position: absolute; inset: 0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; font-weight: bold; color: #7b2cbf; }
  </style>
</head>
<body>

  <div class="header">
    <h3>Resolve Unknown Transactions</h3>
    <div class="toolbar">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Filter descriptions..." onkeyup="filterTable()">
        <span class="search-icon">üîç</span>
      </div>
      <button class="btn-ai" onclick="runAI()">
        <span>‚ú®</span> AI Auto-Categorize
      </button>
    </div>
  </div>

  <div class="table-container">
    <div id="loader">Loading Transactions...</div>
    <table id="mainTable">
      <thead>
        <tr>
          <th class="col-desc">Description</th>
          <th class="col-meta">Count</th>
          <th class="col-meta">Avg Amt</th>
          <th class="col-cat">Category</th>
          <th class="col-type">Type</th>
          <th class="col-action">Link</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div class="footer">
    <div class="status" id="statusLog">Ready.</div>
    <button class="btn-save" onclick="saveRules()">Save Rules</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <script>
    let ALL_DATA = [];
    let CATEGORIES = [];
    let CATEGORY_MAP = {}; // Map category name -> type
    let DROPDOWNS = [];

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
      loadSystemData();
    });

    function loadSystemData() {
      // 1. Get Categories
      google.script.run
        .withSuccessHandler(res => {
          CATEGORIES = res.flatList || [];
          // Build map for auto-setting Type
          CATEGORIES.forEach(c => {
            if(c.category && c.type) CATEGORY_MAP[c.category] = c.type;
          });
          
          // 2. Get Transactions
          loadTransactions();
        })
        .getCategoriesFromSettings();
    }

    function loadTransactions() {
      document.getElementById('loader').style.display = 'flex';
      google.script.run
        .withSuccessHandler(data => {
          ALL_DATA = data || [];
          renderTable(ALL_DATA);
          document.getElementById('loader').style.display = 'none';
          log(`Loaded ${ALL_DATA.length} unknown groups.`);
        })
        .withFailureHandler(err => {
           document.getElementById('loader').innerText = "Error: " + err.message;
        })
        .getUnknownTransactions();
    }

    // --- RENDERING ---
    function renderTable(rows) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      DROPDOWNS = []; // Clear old instances

      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#888;">No unknown transactions found! üéâ</td></tr>';
        return;
      }

      // Pre-build options HTML to speed up loop
      const catOptions = '<option value="">-- Select --</option>' + 
        CATEGORIES.map(c => `<option value="${c.category}">${c.category}</option>`).join('');

      rows.forEach((row, idx) => {
        const tr = document.createElement('tr');
        tr.dataset.idx = idx;
        
        // Determine amount string
        const isOut = row.direction === 'out';
        const amt = isOut ? row.averageDebit : row.averageCredit;
        const amtStr = (isOut ? '-' : '+') + '$' + (Number(amt)||0).toFixed(2);
        const safeDesc = encodeURIComponent(row.keyword);

        tr.innerHTML = `
          <td class="col-desc">${row.keyword}</td>
          <td class="col-meta">${row.count}</td>
          <td class="col-meta" style="color:${isOut ? '#d32f2f' : '#2e7d32'}">${amtStr}</td>
          <td class="col-cat">
            <select class="cat-select" id="cat-${idx}">${catOptions}</select>
          </td>
          <td class="col-type">
            <select class="type-select">
              <option value="Need">Need</option>
              <option value="Want">Want</option>
              <option value="Income">Income</option>
              <option value="Savings">Savings</option>
              <option value="Debt">Debt</option>
              <option value="Unknown" selected>Unknown</option>
            </select>
          </td>
          <td class="col-action">
            <a href="https://www.google.com/search?q=${safeDesc}" target="_blank" class="search-link" title="Google this payee">‚Üó Google</a>
          </td>
        `;

        tbody.appendChild(tr);

        // Initialize Choices.js for this row
        const sel = tr.querySelector(`#cat-${idx}`);
        const choice = new Choices(sel, {
          searchEnabled: true,
          itemSelectText: '',
          shouldSort: false,
          placeholder: true,
          placeholderValue: 'Select Category'
        });
        
        // Add change listener to auto-update Type
        sel.addEventListener('change', (e) => {
           const val = e.detail.value;
           if (CATEGORY_MAP[val]) {
             tr.querySelector('.type-select').value = CATEGORY_MAP[val];
           }
        });

        DROPDOWNS.push({ element: sel, choiceInstance: choice });
      });
    }

    // --- SEARCH FILTER ---
    function filterTable() {
      const term = document.getElementById('searchInput').value.toLowerCase();
      const rows = document.querySelectorAll('#tableBody tr');
      
      rows.forEach(r => {
        const txt = r.querySelector('.col-desc').innerText.toLowerCase();
        r.style.display = txt.includes(term) ? '' : 'none';
      });
    }

    // --- AI AUTO-CATEGORIZE ---
    function runAI() {
      const visibleRows = Array.from(document.querySelectorAll('#tableBody tr')).filter(r => r.style.display !== 'none');
      if (visibleRows.length === 0) return log("No visible rows to categorize.");

      const keywords = visibleRows.map(r => r.querySelector('.col-desc').innerText);
      
      log("AI is thinking...");
      document.body.style.cursor = 'wait';

      google.script.run
        .withSuccessHandler(results => {
          let updates = 0;
          results.forEach((res, i) => {
            if (res.category && res.category !== 'Unknown') {
              const tr = visibleRows[i];
              const idx = tr.dataset.idx;
              
              // Find the choice instance for this row
              const dd = DROPDOWNS[idx]; 
              if (dd) {
                dd.choiceInstance.setChoiceByValue(res.category);
                tr.querySelector('.type-select').value = res.type || 'Unknown';
                tr.classList.add('ai-guessed');
                updates++;
              }
            }
          });
          document.body.style.cursor = 'default';
          log(`AI updated ${updates} rows.`);
        })
        .aiCategorizeTransactions(keywords);
    }

    // --- SAVE ---
    function saveRules() {
      const rules = [];
      const rows = document.querySelectorAll('#tableBody tr');
      
      rows.forEach((tr, i) => {
        const dd = DROPDOWNS[tr.dataset.idx];
        const cat = dd.choiceInstance.getValue(true);
        
        if (cat) {
           const keyword = tr.querySelector('.col-desc').innerText;
           const type = tr.querySelector('.type-select').value;
           // Determine direction from data (using stored global data or UI color)
           // For safety, let's use the 'any' direction or infer from UI class
           const isOut = tr.querySelector('.col-meta').style.color.includes('d32f2f'); // Red = Out
           
           rules.push({
             keyword: keyword,
             category: cat,
             type: type,
             direction: isOut ? 'out' : 'in'
           });
        }
      });

      if (rules.length === 0) return alert("Please assign at least one category before saving.");

      log(`Saving ${rules.length} rules...`);
      
      google.script.run
        .withSuccessHandler(res => {
          alert(`Success! Saved ${res.saved} rules. The budget system is refreshing...`);
          // Reload to show remaining unknowns
          loadTransactions();
        })
        .withFailureHandler(err => alert("Error saving: " + err.message))
        .resolveUnknownTransactions(rules);
    }

    function log(msg) {
      document.getElementById('statusLog').innerText = msg;
    }

  </script>
</body>
</html>